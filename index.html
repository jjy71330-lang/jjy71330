<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ACDelco ì˜ˆì•½ëŒ€ì¥</title>
    <style>
        /* í™”ë©´ ì „ì²´ ë””ìì¸ */
        body { font-family: 'Malgun Gothic', sans-serif; background-color: #f0f2f5; margin: 0; padding: 10px; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 15px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        
        .header { text-align: center; border-bottom: 3px solid #000; padding-bottom: 10px; margin-bottom: 15px; }
        .header h1 { margin: 0; font-size: 26px; color: #000; }

        /* ìƒíƒœì°½ */
        .status-bar { background: #1e293b; color: white; padding: 10px; border-radius: 8px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; font-size: 14px; }
        #sync-text { font-weight: bold; padding: 3px 8px; border-radius: 4px; background: #555; }

        /* ë‚ ì§œ ì„ íƒ */
        .date-bar { display: flex; justify-content: center; align-items: center; gap: 10px; margin-bottom: 15px; }
        .btn { border: none; padding: 10px 15px; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 16px; }
        .btn-blue { background: #4f46e5; color: white; }
        .btn-green { background: #28a745; color: white; }
        #target-date { font-size: 20px; font-weight: bold; padding: 5px; border: 2px solid #ddd; }

        /* í‘œ ë§Œë“¤ê¸° */
        .grid-head { display: grid; grid-template-columns: 80px 1fr 1fr 1fr; gap: 5px; background: #eee; text-align: center; font-weight: bold; padding: 10px 0; border-bottom: 2px solid #333; }
        .row { display: grid; grid-template-columns: 80px 1fr 1fr 1fr; gap: 5px; border-bottom: 1px solid #ddd; min-height: 100px; padding: 5px 0; }
        .time-cell { display: flex; align-items: center; justify-content: center; font-weight: bold; background: #f8f9fa; font-size: 18px; }
        
        /* ì˜ˆì•½ ì¹¸ */
        .slot { background: #fff; border: 1px solid #ccc; border-radius: 6px; padding: 5px; cursor: pointer; display: flex; flex-direction: column; justify-content: center; overflow: hidden; }
        .slot.booked { background-color: #0052cc !important; color: white !important; }
        .slot.done { background-color: #7f8c8d !important; color: #ccc !important; }
        
        .car-no { font-weight: 900; font-size: 19px; }
        .car-info { font-size: 14px; }
        .worker { font-size: 14px; color: #ffeb3b; font-weight: bold; }

        /* ì…ë ¥ì°½(ëª¨ë‹¬) */
        #modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); justify-content:center; align-items:center; z-index:999; }
        .modal-box { background:white; padding:20px; border-radius:12px; width:320px; }
        input { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 16px; }
        .modal-btns { display: flex; gap: 5px; margin-top: 15px; }
        .modal-btns button { flex: 1; padding: 12px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

<div class="container">
    <div class="header"><h1>ACDelco ì˜ˆì•½ëŒ€ì¥</h1></div>
    
    <div class="status-bar">
        <div>ğŸ“¡ ìƒíƒœ: <span id="sync-text">ì—°ê²°ì¤‘...</span></div>
        <button class="btn" onclick="loadData()" style="padding: 5px 10px; font-size: 12px;">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
    </div>

    <div class="date-bar">
        <button class="btn btn-blue" onclick="moveDate(-1)">â—€ ì–´ì œ</button>
        <input type="date" id="target-date" onchange="loadData()">
        <button class="btn btn-blue" onclick="moveDate(1)">ë‚´ì¼ â–¶</button>
    </div>

    <div class="grid-head">
        <div>ì‹œê°„</div><div>ë¦¬í”„íŠ¸ 1</div><div>ë¦¬í”„íŠ¸ 2</div><div>ë¦¬í”„íŠ¸ 3</div>
    </div>
    <div id="table-body"></div>
</div>

<div id="modal">
    <div class="modal-box">
        <h3 style="text-align:center; margin:0;">ì˜ˆì•½ ë“±ë¡</h3>
        <input type="text" id="inCarNo" placeholder="ì°¨ëŸ‰ë²ˆí˜¸">
        <input type="text" id="inModel" placeholder="ì°¨ì¢…">
        <input type="text" id="inWork" placeholder="ì‘ì—…ë‚´ìš©">
        <input type="text" id="inWorker" placeholder="ë‹´ë‹¹ì">
        <div style="margin: 10px 0;">
            <label style="font-weight:bold;"><input type="checkbox" id="inDone"> ì •ë¹„ ì™„ë£Œ</label>
        </div>
        <div class="modal-btns">
            <button style="background:#4f46e5; color:white;" onclick="doSave()">ì €ì¥</button>
            <button style="background:#dc3545; color:white;" onclick="doDelete()">ì‚­ì œ</button>
            <button style="background:#666; color:white;" onclick="closeModal()">ë‹«ê¸°</button>
        </div>
    </div>
</div>

<script>
    const timeList = ["09:00", "10:00", "11:00", "12:00", "13:00", "14:00", "15:00", "16:00", "17:00"];
    let db = {};
    let selectedId = "";
    const KEY_URL = "https://kvdb.io/A8v8bY6G7z5Lq9x4E3wR1t/jjy_v3"; // ì €ì¥ì†Œ ì£¼ì†Œ

    function init() {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('target-date').value = today;
        loadData();
        setInterval(loadData, 10000); // 10ì´ˆë§ˆë‹¤ ìë™ ì—…ë°ì´íŠ¸
    }

    // ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
    async function loadData() {
        const date = document.getElementById('target-date').value;
        try {
            const res = await fetch(`${KEY_URL}_${date}?t=${Date.now()}`);
            if (res.ok) {
                db = await res.json();
                document.getElementById('sync-text').innerText = "ğŸŸ¢ ì‹¤ì‹œê°„ ì—°ê²°ë¨";
                document.getElementById('sync-text').style.background = "#28a745";
            } else {
                db = {};
                document.getElementById('sync-text').innerText = "âšª ìƒˆ ë¬¸ì„œ";
                document.getElementById('sync-text').style.background = "#666";
            }
        } catch (e) {
            document.getElementById('sync-text').innerText = "ğŸ”´ ì—°ê²°ëŠê¹€";
            document.getElementById('sync-text').style.background = "#dc3545";
        }
        render();
    }

    // ì„œë²„ì— ì €ì¥í•˜ê¸°
    async function saveData() {
        const date = document.getElementById('target-date').value;
        try {
            await fetch(`${KEY_URL}_${date}`, {
                method: 'POST',
                body: JSON.stringify(db)
            });
            document.getElementById('sync-text').innerText = "âœ… ì„œë²„ì €ì¥ ì™„ë£Œ";
        } catch (e) {
            document.getElementById('sync-status').innerText = "âš ï¸ ì„œë²„ì „ì†¡ ì‹¤íŒ¨";
        }
    }

    // í™”ë©´ ê·¸ë¦¬ê¸°
    function render() {
        const container = document.getElementById('table-body');
        container.innerHTML = '';

        timeList.forEach(t => {
            const row = document.createElement('div');
            row.className = 'row';
            row.innerHTML = `<div class="time-cell">${t}</div>`;

            if (t === "12:00") {
                row.innerHTML += `<div style="grid-column: span 3; background:#ffe3e3; color:#e03131; display:flex; align-items:center; justify-content:center; font-weight:bold;">ğŸ´ ì  ì‹¬ ì‹œ ê°„</div>`;
            } else {
                for (let i = 1; i <= 3; i++) {
                    const id = t + '-' + i;
                    const data = db[id];
                    let slotClass = 'slot';
                    let content = '';

                    if (data) {
                        slotClass += ' booked';
                        if (data.isDone) slotClass += ' done';
                        content = `
                            <div class="car-no">${data.isDone ? 'âœ…' : ''}${data.carNo}</div>
                            <div class="car-info">${data.model}</div>
                            <div class="worker">${data.worker}</div>
                        `;
                    }
                    row.innerHTML += `<div class="${slotClass}" onclick="openModal('${id}')">${content}</div>`;
                }
            }
            container.appendChild(row);
        });
    }

    function openModal(id) {
        selectedId = id;
        const data = db[id] || { carNo: '', model: '', work: '', worker: '', isDone: false };
        document.getElementById('inCarNo').value = data.carNo;
        document.getElementById('inModel').value = data.model;
        document.getElementById('inWork').value = data.work;
        document.getElementById('inWorker').value = data.worker;
        document.getElementById('inDone').checked = data.isDone;
        document.getElementById('modal').style.display = 'flex';
    }

    function closeModal() { document.getElementById('modal').style.display = 'none'; }

    function doSave() {
        const carNo = document.getElementById('inCarNo').value;
        if (!carNo) return alert("ì°¨ëŸ‰ë²ˆí˜¸ë¥¼ ì¨ì£¼ì„¸ìš”!");

        // 1. ë°ì´í„° ì €ì¥
        db[selectedId] = {
            carNo: carNo,
            model: document.getElementById('inModel').value,
            work: document.getElementById('inWork').value,
            worker: document.getElementById('inWorker').value,
            isDone: document.getElementById('inDone').checked
        };

        // 2. ì¦‰ì‹œ í™”ë©´ ì—…ë°ì´íŠ¸
        render();
        closeModal();

        // 3. ì„œë²„ ì „ì†¡
        saveData();
    }

    function doDelete() {
        if (!confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        delete db[selectedId];
        render();
        closeModal();
        saveData();
    }

    function moveDate(days) {
        const dt = new Date(document.getElementById('target-date').value);
        dt.setDate(dt.getDate() + days);
        document.getElementById('target-date').value = dt.toISOString().split('T')[0];
        loadData();
    }

    // ì•± ì‹œì‘
    init();
</script>
</body>
</html>
