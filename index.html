<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ACDelco ì˜ˆì•½ëŒ€ì¥ (ìµœì¢…ë³µêµ¬)</title>
    <style>
        body { font-family: 'Malgun Gothic', sans-serif; background-color: #f0f2f5; margin: 0; padding: 10px; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 15px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .header { text-align: center; border-bottom: 3px solid #000; padding-bottom: 10px; margin-bottom: 15px; }
        .status-bar { background: #1e293b; color: white; padding: 10px; border-radius: 8px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; font-size: 14px; }
        #sync-text { font-weight: bold; padding: 5px 12px; border-radius: 4px; background: #666; }
        .date-bar { display: flex; justify-content: center; align-items: center; gap: 8px; margin-bottom: 15px; }
        .btn { border: none; padding: 10px 15px; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 16px; }
        .btn-blue { background: #4f46e5; color: white; }
        #target-date { font-size: 20px; font-weight: bold; padding: 5px; border: 2px solid #ddd; }
        .grid-head { display: grid; grid-template-columns: 80px 1fr 1fr 1fr; gap: 5px; background: #eee; text-align: center; font-weight: bold; padding: 10px 0; border-bottom: 2px solid #333; }
        .row { display: grid; grid-template-columns: 80px 1fr 1fr 1fr; gap: 5px; border-bottom: 1px solid #ddd; min-height: 105px; padding: 5px 0; }
        .time-cell { display: flex; align-items: center; justify-content: center; font-weight: bold; background: #f8f9fa; font-size: 18px; }
        .slot { background: #fff; border: 1px solid #ccc; border-radius: 6px; padding: 8px; cursor: pointer; display: flex; flex-direction: column; justify-content: center; overflow: hidden; }
        .slot.booked { background-color: #0052cc !important; color: white !important; }
        .slot.done { background-color: #7f8c8d !important; color: #ccc !important; }
        .car-no { font-weight: 900; font-size: 20px; }
        .worker { font-size: 14px; color: #ffeb3b; font-weight: bold; }
        #modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); justify-content:center; align-items:center; z-index:999; }
        .modal-box { background:white; padding:25px; border-radius:12px; width:320px; }
        input { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 16px; }
        .modal-btns { display: flex; gap: 5px; margin-top: 15px; }
        .modal-btns button { flex: 1; padding: 12px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

<div class="container">
    <div class="header"><h1>ACDelco ì˜ˆì•½ëŒ€ì¥</h1></div>
    <div class="status-bar">
        <div>ğŸ“¡ ìƒíƒœ: <span id="sync-text">ì—°ê²° ì¤€ë¹„</span></div>
        <button onclick="loadData()" style="cursor:pointer; padding:5px 10px; border-radius:4px;">ğŸ”„ ìˆ˜ë™ ì—°ë™</button>
    </div>
    <div class="date-bar">
        <button class="btn btn-blue" onclick="moveDate(-1)">â—€ ì–´ì œ</button>
        <input type="date" id="target-date" onchange="loadData()">
        <button class="btn btn-blue" onclick="moveDate(1)">ë‚´ì¼ â–¶</button>
    </div>
    <div class="grid-head"><div>ì‹œê°„</div><div>ë¦¬í”„íŠ¸ 1</div><div>ë¦¬í”„íŠ¸ 2</div><div>ë¦¬í”„íŠ¸ 3</div></div>
    <div id="table-body"></div>
</div>

<div id="modal">
    <div class="modal-box">
        <h3 style="text-align:center;">ì˜ˆì•½ ë“±ë¡</h3>
        <input type="text" id="inCarNo" placeholder="ì°¨ëŸ‰ë²ˆí˜¸">
        <input type="text" id="inModel" placeholder="ì°¨ì¢…">
        <input type="text" id="inWork" placeholder="ì‘ì—…ë‚´ìš©">
        <input type="text" id="inWorker" placeholder="ë‹´ë‹¹ì">
        <div style="margin: 10px 0;"><label><input type="checkbox" id="inDone"> ì •ë¹„ ì™„ë£Œ</label></div>
        <div class="modal-btns">
            <button style="background:#4f46e5; color:white;" onclick="doSave()">ì €ì¥</button>
            <button style="background:#dc3545; color:white;" onclick="doDelete()">ì‚­ì œ</button>
            <button style="background:#666; color:white;" onclick="closeModal()">ë‹«ê¸°</button>
        </div>
    </div>
</div>

<script>
    const timeList = ["09:00", "10:00", "11:00", "12:00", "13:00", "14:00", "15:00", "16:00", "17:00"];
    let db = {};
    let selectedId = "";
    let isSaving = false; 
    const KEY_URL = "https://kvdb.io/A8v8bY6G7z5Lq9x4E3wR1t/acdelco_final_v9"; // ğŸš€ ìƒˆ ë³´ê´€í•¨ ì£¼ì†Œ

    function init() {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('target-date').value = today;
        
        // 1. ë‚´ ê¸°ê¸°ì— ì €ì¥ëœ ë°ì´í„°ê°€ ìˆìœ¼ë©´ ë¨¼ì € ë³´ì—¬ì£¼ê¸°
        const backup = localStorage.getItem('local_db_' + today);
        if(backup) {
            db = JSON.parse(backup);
            render();
        }
        
        loadData();
        setInterval(() => { if(!isSaving) loadData(); }, 10000); 
    }

    async function loadData() {
        if (isSaving) return;
        const date = document.getElementById('target-date').value;
        const status = document.getElementById('sync-text');
        try {
            const res = await fetch(`${KEY_URL}_${date}?t=${Date.now()}`);
            if (res.ok) {
                const serverData = await res.json();
                
                // âœ… í•µì‹¬: ì„œë²„ ë°ì´í„°ê°€ ë¹„ì–´ìˆì§€ ì•Šì„ ë•Œë§Œ í™”ë©´ì„ ë°”ê¿ˆ (ì‚¬ë¼ì§ ë°©ì§€)
                if (Object.keys(serverData).length > 0) {
                    db = serverData;
                    localStorage.setItem('local_db_' + date, JSON.stringify(db));
                    render();
                    status.innerText = "ğŸŸ¢ ì—°ë™ ì„±ê³µ";
                    status.style.background = "#28a745";
                } else {
                    status.innerText = "âšª ìƒˆ ë¬¸ì„œ ìƒíƒœ";
                    status.style.background = "#666";
                }
            }
        } catch (e) {
            status.innerText = "ğŸ”´ ì—°ê²°ëŠê¹€";
            status.style.background = "#dc3545";
        }
    }

    async function saveData() {
        isSaving = true;
        const date = document.getElementById('target-date').value;
        const status = document.getElementById('sync-text');
        
        // ë‚´ ê¸°ê¸°ì— ì¦‰ì‹œ ì €ì¥ (ì ˆëŒ€ ì•ˆ ì‚¬ë¼ì§)
        localStorage.setItem('local_db_' + date, JSON.stringify(db));
        render();

        try {
            await fetch(`${KEY_URL}_${date}`, {
                method: 'POST',
                body: JSON.stringify(db)
            });
            status.innerText = "âœ… ì„œë²„ ì €ì¥ë¨";
            status.style.background = "#28a745";
        } catch (e) {
            status.innerText = "âš ï¸ ì„ì‹œ ì €ì¥ë¨";
            status.style.background = "#e67e22";
        }
        setTimeout(() => { isSaving = false; }, 5000); 
    }

    function render() {
        const container = document.getElementById('table-body');
        if(!container) return;
        container.innerHTML = '';
        timeList.forEach(t => {
            const row = document.createElement('div');
            row.className = 'row';
            row.innerHTML = `<div class="time-cell">${t}</div>`;
            if (t === "12:00") {
                row.innerHTML += `<div style="grid-column: span 3; background:#ffe3e3; color:#e03131; display:flex; align-items:center; justify-content:center; font-weight:bold;">ğŸ´ ì  ì‹¬ ì‹œ ê°„</div>`;
            } else {
                for (let i = 1; i <= 3; i++) {
                    const id = t + '-' + i;
                    const data = db[id];
                    let slotClass = 'slot';
                    let content = '';
                    if (data) {
                        slotClass += ' booked';
                        if (data.isDone) slotClass += ' done';
                        content = `<div class="car-no">${data.isDone ? 'âœ…' : ''}${data.carNo}</div><div class="worker">${data.worker}</div>`;
                    }
                    row.innerHTML += `<div class="${slotClass}" onclick="openModal('${id}')">${content}</div>`;
                }
            }
            container.appendChild(row);
        });
    }

    function openModal(id) {
        selectedId = id;
        const data = db[id] || { carNo: '', model: '', work: '', worker: '', isDone: false };
        document.getElementById('inCarNo').value = data.carNo;
        document.getElementById('inModel').value = data.model;
        document.getElementById('inWork').value = data.work;
        document.getElementById('inWorker').value = data.worker;
        document.getElementById('inDone').checked = data.isDone;
        document.getElementById('modal').style.display = 'flex';
    }

    function closeModal() { document.getElementById('modal').style.display = 'none'; }

    function doSave() {
        const carNo = document.getElementById('inCarNo').value;
        if (!carNo) return alert("ì°¨ëŸ‰ë²ˆí˜¸ë¥¼ ì¨ì£¼ì„¸ìš”!");
        db[selectedId] = {
            carNo: carNo,
            model: document.getElementById('inModel').value,
            work: document.getElementById('inWork').value,
            worker: document.getElementById('inWorker').value,
            isDone: document.getElementById('inDone').checked
        };
        render();
        closeModal();
        saveData();
    }

    function doDelete() {
        if (!confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        delete db[selectedId];
        render();
        closeModal();
        saveData();
    }

    function moveDate(days) {
        const dt = new Date(document.getElementById('target-date').value);
        dt.setDate(dt.getDate() + days);
        document.getElementById('target-date').value = dt.toISOString().split('T')[0];
        loadData();
    }

    init();
</script>
</body>
</html>
